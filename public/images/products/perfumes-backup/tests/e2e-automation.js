// Script de automa√ß√£o E2E para JC Hair Studio's 62 E-commerce
// Testa funcionalidades cr√≠ticas usando Puppeteer e axios

const puppeteer = require('puppeteer');
const axios = require('axios');
const fs = require('fs');
const path = require('path');

// Configura√ß√µes do ambiente de teste
const BASE_URL = process.env.TEST_BASE_URL || 'http://localhost:3001';
const TEST_EMAILS = [
  'juliocesarurss65@gmail.com',
  'juliana.dayane110@gmail.com',
];

// Configura√ß√£o do Puppeteer
const BROWSER_CONFIG = {
  headless: process.env.TEST_HEADLESS !== 'false',
  defaultViewport: { width: 1280, height: 720 },
  args: ['--no-sandbox', '--disable-setuid-sandbox']
};

// Utilit√°rios
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

class ECommerceTestSuite {
  constructor() {
    this.browser = null;
    this.page = null;
    this.results = {
      passed: 0,
      failed: 0,
      errors: []
    };
  }

  async setup() {
    console.log('üöÄ Iniciando testes de E-commerce JC Hair Studio\'s 62');
    console.log(`üìç URL Base: ${BASE_URL}`);

    this.browser = await puppeteer.launch(BROWSER_CONFIG);
    this.page = await this.browser.newPage();

    // Configurar intercepta√ß√£o de erros de console
    this.page.on('console', msg => {
      if (msg.type() === 'error') {
        console.log('‚ùå Erro de console:', msg.text());
      }
    });

    // Configurar timeout padr√£o
    this.page.setDefaultTimeout(10000);
  }

  async teardown() {
    if (this.browser) {
      await this.browser.close();
    }

    console.log('\nüìä Resultados dos Testes:');
    console.log(`‚úÖ Passou: ${this.results.passed}`);
    console.log(`‚ùå Falhou: ${this.results.failed}`);

    if (this.results.errors.length > 0) {
      console.log('\nüîç Erros encontrados:');
      this.results.errors.forEach((error, index) => {
        console.log(`${index + 1}. ${error}`);
      });
    }
  }

  async test(testName, testFn) {
    try {
      console.log(`\nüß™ ${testName}`);
      await testFn();
      console.log(`‚úÖ ${testName} - PASSOU`);
      this.results.passed++;
    } catch (error) {
      console.log(`‚ùå ${testName} - FALHOU: ${error.message}`);
      this.results.failed++;
      this.results.errors.push(`${testName}: ${error.message}`);
    }
  }

  // Teste 1: Verificar se o servidor est√° rodando
  async testServerHealth() {
    const response = await axios.get(BASE_URL, { timeout: 5000 });
    if (response.status !== 200) {
      throw new Error(`Servidor retornou status ${response.status}`);
    }
  }

  // Teste 2: Seed do banco de dados
  async testDatabaseSeed() {
    try {
      const response = await axios.get(`${BASE_URL}/api/seed`, { timeout: 30000 });
      console.log(`   üìä Seed executado: HTTP ${response.status}`);

      if (response.data && response.data.message) {
        console.log(`   üìù ${response.data.message}`);
      }
    } catch (error) {
      if (error.response?.status === 404) {
        console.log('   ‚ö†Ô∏è  Endpoint /api/seed n√£o encontrado - pulando');
        return;
      }
      throw error;
    }
  }

  // Teste 3: Verificar produtos no cat√°logo
  async testProductCatalog() {
    await this.page.goto(`${BASE_URL}/produtos`, { waitUntil: 'networkidle2' });

    // Verificar se produtos carregaram
    await this.page.waitForSelector('[data-testid="product-card"], .product-card, .grid > div', { timeout: 10000 });

    const products = await this.page.$$('[data-testid="product-card"], .product-card, .grid > div');
    console.log(`   üì¶ Produtos encontrados: ${products.length}`);

    if (products.length === 0) {
      throw new Error('Nenhum produto encontrado no cat√°logo');
    }

    // Verificar se pelo menos um produto tem imagem
    const productWithImage = await this.page.$('img[src*="/images/products"], img[alt*="produto"]');
    if (productWithImage) {
      console.log('   üñºÔ∏è  Imagens de produtos carregando corretamente');
    }
  }

  // Teste 4: Funcionalidade do carrinho
  async testCartFunctionality() {
    await this.page.goto(`${BASE_URL}/produtos`, { waitUntil: 'networkidle2' });

    // Procurar por bot√µes de adicionar ao carrinho
    const addToCartSelectors = [
      'button[data-testid="add-to-cart"]',
      'button:has-text("Adicionar")',
      'button:has-text("Comprar")',
      '.add-to-cart',
      'button[aria-label*="adicionar"]'
    ];

    let addToCartButton = null;
    for (const selector of addToCartSelectors) {
      try {
        addToCartButton = await this.page.$(selector);
        if (addToCartButton) break;
      } catch (e) {
        continue;
      }
    }

    if (addToCartButton) {
      await addToCartButton.click();
      await delay(1000);
      console.log('   üõí Item adicionado ao carrinho');

      // Verificar se carrinho foi atualizado
      const cartIndicator = await this.page.$('[data-testid="cart-count"], .cart-count, .badge');
      if (cartIndicator) {
        const count = await cartIndicator.textContent();
        console.log(`   üìä Itens no carrinho: ${count}`);
      }
    } else {
      console.log('   ‚ö†Ô∏è  Bot√£o de adicionar ao carrinho n√£o encontrado');
    }
  }

  // Teste 5: Newsletter signup
  async testNewsletterSignup() {
    try {
      const response = await axios.post(`${BASE_URL}/api/newsletter`, {
        email: TEST_EMAILS[1],
        name: 'Teste Automatizado'
      }, {
        headers: { 'Content-Type': 'application/json' },
        timeout: 10000
      });

      console.log(`   üìß Newsletter API: HTTP ${response.status}`);

      if (response.status === 200 || response.status === 201) {
        console.log('   ‚úÖ Newsletter signup funcionando');
      }
    } catch (error) {
      if (error.response?.status === 404) {
        console.log('   ‚ö†Ô∏è  API /api/newsletter n√£o encontrada');
        return;
      }
      throw new Error(`Newsletter signup falhou: ${error.message}`);
    }
  }

  // Teste 6: Formul√°rio de contato
  async testContactForm() {
    try {
      const response = await axios.post(`${BASE_URL}/api/contact`, {
        name: 'Teste Automatizado',
        email: TEST_EMAILS[0],
        subject: 'Teste de automa√ß√£o',
        message: 'Esta √© uma mensagem de teste automatizada.'
      }, {
        headers: { 'Content-Type': 'application/json' },
        timeout: 15000
      });

      console.log(`   üìß Contact API: HTTP ${response.status}`);

      if (response.status === 200 || response.status === 201) {
        console.log('   ‚úÖ Formul√°rio de contato funcionando');
      }
    } catch (error) {
      if (error.response?.status === 404) {
        console.log('   ‚ö†Ô∏è  API /api/contact n√£o encontrada');
        return;
      }
      throw new Error(`Formul√°rio de contato falhou: ${error.message}`);
    }
  }

  // Teste 7: P√°ginas principais
  async testMainPages() {
    const pages = [
      { path: '/', name: 'Home' },
      { path: '/produtos', name: 'Produtos' },
      { path: '/sobre', name: 'Sobre' },
      { path: '/mega-hair', name: 'Mega Hair' },
      { path: '/cosmeticos', name: 'Cosm√©ticos' }
    ];

    for (const { path, name } of pages) {
      try {
        await this.page.goto(`${BASE_URL}${path}`, {
          waitUntil: 'networkidle2',
          timeout: 10000
        });

        // Verificar se a p√°gina carregou sem erro 404
        const title = await this.page.title();
        const is404 = title.toLowerCase().includes('404') ||
                     title.toLowerCase().includes('not found');

        if (is404) {
          console.log(`   ‚ö†Ô∏è  P√°gina ${name} (${path}) n√£o encontrada`);
        } else {
          console.log(`   ‚úÖ P√°gina ${name} carregou corretamente`);
        }
      } catch (error) {
        console.log(`   ‚ùå Erro ao carregar ${name}: ${error.message}`);
      }
    }
  }

  // Teste 8: Autentica√ß√£o NextAuth
  async testAuthentication() {
    await this.page.goto(`${BASE_URL}/auth/signin`, { waitUntil: 'networkidle2' });

    // Verificar se p√°gina de login existe
    const signInForm = await this.page.$('form, [data-testid="signin-form"]');
    const googleButton = await this.page.$('button:has-text("Google"), [data-provider="google"]');

    if (signInForm || googleButton) {
      console.log('   üîê P√°gina de autentica√ß√£o encontrada');

      if (googleButton) {
        console.log('   üåê Login Google dispon√≠vel');
      }
    } else {
      console.log('   ‚ö†Ô∏è  P√°gina de autentica√ß√£o n√£o encontrada ou diferente do esperado');
    }
  }

  // Teste 9: Responsividade mobile
  async testMobileResponsiveness() {
    await this.page.setViewport({ width: 375, height: 667 });
    await this.page.goto(BASE_URL, { waitUntil: 'networkidle2' });

    // Verificar se menu mobile existe
    const mobileMenu = await this.page.$('[data-testid="mobile-menu"], .mobile-menu, .hamburger, .menu-toggle');

    if (mobileMenu) {
      console.log('   üì± Menu mobile encontrado');
    } else {
      console.log('   ‚ö†Ô∏è  Menu mobile n√£o encontrado');
    }

    // Resetar viewport
    await this.page.setViewport({ width: 1280, height: 720 });
  }

  // Teste 10: Performance b√°sica
  async testBasicPerformance() {
    const startTime = Date.now();
    await this.page.goto(BASE_URL, { waitUntil: 'networkidle2' });
    const loadTime = Date.now() - startTime;

    console.log(`   ‚è±Ô∏è  Tempo de carregamento: ${loadTime}ms`);

    if (loadTime > 5000) {
      console.log('   ‚ö†Ô∏è  P√°gina lenta (>5s)');
    } else {
      console.log('   ‚úÖ Tempo de carregamento aceit√°vel');
    }
  }
}

// Executar todos os testes
async function runAllTests() {
  const testSuite = new ECommerceTestSuite();

  try {
    await testSuite.setup();

    await testSuite.test('Verificar sa√∫de do servidor', () => testSuite.testServerHealth());
    await testSuite.test('Executar seed do banco de dados', () => testSuite.testDatabaseSeed());
    await testSuite.test('Verificar cat√°logo de produtos', () => testSuite.testProductCatalog());
    await testSuite.test('Testar funcionalidade do carrinho', () => testSuite.testCartFunctionality());
    await testSuite.test('Testar signup newsletter', () => testSuite.testNewsletterSignup());
    await testSuite.test('Testar formul√°rio de contato', () => testSuite.testContactForm());
    await testSuite.test('Verificar p√°ginas principais', () => testSuite.testMainPages());
    await testSuite.test('Testar autentica√ß√£o', () => testSuite.testAuthentication());
    await testSuite.test('Testar responsividade mobile', () => testSuite.testMobileResponsiveness());
    await testSuite.test('Testar performance b√°sica', () => testSuite.testBasicPerformance());

  } finally {
    await testSuite.teardown();
  }

  process.exit(testSuite.results.failed > 0 ? 1 : 0);
}

// Executar se chamado diretamente
if (require.main === module) {
  runAllTests().catch(console.error);
}

module.exports = { ECommerceTestSuite, runAllTests };